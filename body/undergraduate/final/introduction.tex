\clearpage

\section{绪论}

\subsection{背景介绍}

光纤传感器的出现让实时确定物体的形态成为了一个很有前景的研究方向\cite{recent-dev-in-foss}。
光纤形变传感器（Fiber Optic Shape Sensors, FOSS）被设计用于定向应变测量，例如，
FOSS可以由三芯光纤布拉格光栅（Fiber Bragg Grating, FBG）传感器组成，
该传感器测量应变以进行对象的多维曲率计算，可以在计算机模型中用于重建对象的二维和三维形状。
然而，未闻有学者研究过如何为形变传感器构建一个通用的三维可视化软件。

另一方面，随着软件工程的发展，有无数种编程语言和渲染技术诞生，从中选择合适的技术栈成为了一大难题。
仅是OpenGL\cite{opengl}技术本身就有JavaScript绑定的WebGL\cite{webgl}；
C绑定的WGL、GLX和CGL；iOS提供的C绑定和Android提供的Java和C绑定等。

\subsection{形变传感器的研究方向及进展}

形变传感器主要分为两大类，一类是传统形变传感器（Conventional Shape Sensors, CSS），
另一类是光纤形变传感器（Fiber Optic Shape Sensors, FOSS）， 
其中传统形变传感器又分为非接触式和接触式两种。

非接触式传感器包括视觉系统传感器（如相机）、
无线电监测与测距（Radio Detection and Ranging, RaDAR）
或光监测与测距（Light Detection and Ranging, LiDAR）传感器，
这些传感器的性能与正确性受环境温度和污染干扰很大。

随着传感器的需求场景越来越多且复杂，非接触传感系统越来越局限，
对小型且灵活的接触式传感器的需求也就越来越大。
接触式传感器可以直接连接到物体上随其移动，
并将位置转换为光、电信号以感测形状、曲率、弯曲和扭曲。

\subsubsection{接触式传统形变传感器}

接触式CSS主要分为电阻压力传感器、光电传感器和微机电系统（Micro-Electo-Mechanical System, MEMS）传感器，
它们各自的简介、优缺点和应用如表~\ref{table:css}所示。

\begin{table}[h]\small
\begin{center}
\begin{tabular}{p{0.16\textwidth}p{0.16\textwidth}p{0.24\textwidth}p{0.24\textwidth}}
\toprule
\textbf{传感器技术} & \textbf{简介} & \makebox[5cm][c]{\textbf{优点与应用}} & \makebox[5cm][c]{\textbf{缺点}}\\

\midrule

电阻压力传感器 & 用于短距离二维弯曲或关节运动测量。&
\begin{minipage}[t]{0.24\textwidth}
\begin{itemize}
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\setlength{\parskip}{0pt}
\item 低成本；
\item 与其它电器件相兼容；
\item 非常适用于可穿戴电子产品。
\end{itemize}
\end{minipage}
& 
\begin{minipage}[t]{0.24\textwidth}
\begin{itemize}
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\setlength{\parskip}{0pt}
\item 不够精准；
\item 尺寸重量过大，不适用于小尺寸的自动控制应用；
\item 复杂且接线繁琐，不适用于大规模应用。
\end{itemize}
\end{minipage}
\\

\midrule

光电传感器 & 基于密集的传感器网络工作：一种可计算物体3D表面的算法解决方案；一种电阻率传感器网络；三轴陀螺仪、三轴加速 度计和航班时间距离传感器。&
\begin{minipage}[t]{0.24\textwidth}
\begin{itemize}
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\setlength{\parskip}{0pt}
    \item 作为可穿戴设备检测脊椎姿势变化，进行医疗运动和预防伤害方面具有巨大潜力；
    \item 易于大规模生产；
    \item 与Arduinos等价格低廉的微电子设备兼容。
\end{itemize}
\end{minipage}
& 
\begin{minipage}[t]{0.24\textwidth}
\begin{itemize}
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\setlength{\parskip}{0pt}
    \item 对于工业应用而言，不是可靠且准确的解决方案；
    \item 要求传感器周围有自由空间，以便光学传感器能够正常工作；
    \item 无法保证精度；
    \item 不够灵活。
\end{itemize}
\end{minipage} \\

\midrule

MEMS传感器 & 结合了加速度计、陀螺仪和磁力计的微电机系统。&
\begin{minipage}[t]{0.24\textwidth}
\begin{itemize}
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\setlength{\parskip}{0pt}
    \item 钻井；
    \item 地面监控；
    \item 远程测量；
    \item 适用于密闭空间；
    \item 精加工。
\end{itemize}
\end{minipage}
& 
\begin{minipage}[t]{0.24\textwidth}
\begin{itemize}
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\setlength{\parskip}{0pt}
    \item 难以定制；
    \item 笨重；
    \item 低柔韧性（长关节）；
    \item 测量分辨率低；
    \item 昂贵。
\end{itemize} 
\end{minipage} \\
\bottomrule
\end{tabular}
\end{center}
\caption{接触式CSS的优缺点对比\cite{recent-dev-in-foss}}
\label{table:css}
\end{table}

分析可知这三种CSS传感器各自的适用场景：

\begin{itemize}
    \item 电阻压力传感器适用于消费级电子产品，如游戏用压感器、心率检测仪等。
    \item 光电传感器适用于通用基础设备，如医疗运动用人体肌肉脊椎形状传感。
    \item MEMS传感器适用于大型工程，如钻井、海床监控等。
\end{itemize}

\FloatBarrier
\subsubsection{光纤形变传感器}
光纤传感的出现让实时确定物体的形态成为了一个很有前景的研究方向。
FOSS利用光纤传感器（Fiber Optic Sensors, FOS）来实现相对位置测量，
或是使用嵌入式FOS实现物体形状的测量。
FOSS被设计用于定向应变测量，例如，
FOSS可以由三芯光纤布拉格光栅（Fiber Bragg Grating, FBG）传感器组成，
该传感器测量应变以进行对象的多维曲率计算，因此可以在计算机模型中用于重建对象的二维和三维形状。

通常，FOSS与CSS相比具有许多明显而实用的优点，例如：
\begin{itemize}
\setlength{\topsep}{0pt}
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\setlength{\parskip}{0pt}
\item FOSS可以仅由一个远程询问器单元进行监控，而无需布线和连接许多传感器。
\item 传感元件（如光纤光栅）的位置不需要电力，抗电磁干扰能力强。
\item 小尺寸的光纤（直径在100μm和2mm之间）可以嵌入非常薄的物体中。
\end{itemize}

FOSS的发展趋势如表~\ref{table:foss}所示。
可知早在1999年，ShapeTape\cite{ShapeTape}已尝试基于光纤传感器感测物体表面的形变并可视化，
但因技术上的限制没有取得很大的成果；而截至2017年，
FOSS在测量范围（长光纤）、精度、维度（弯曲、扭曲和力）等方面均取得了一定的进展，
为新一代FOSS构建通用三维可视化软件的需求也逐渐显现。

\begin{table}\footnotesize
\begin{center}
\tabcolsep=0.10cm
\begin{tabular}{p{0.16\textwidth}cp{0.64\textwidth}}
\toprule
\textbf{进展} & \textbf{年份} & \makebox[5cm][c]{\textbf{简介}}\\

\midrule

弯曲传感器 & \textasciitilde 1980 & 确定了三种主要的早期弯曲感测方法。它们分别是：
通过正常光纤传输的功率变化感测；
通过配备了弯曲调制器的光纤传输功率变化感测；
通过同一包层中并行核心之间的串扰而导致的传输功率变化感测。
\\
\\
定向弯曲传感器 & \textasciitilde 1990 & 通过使用多根单独的光纤和多芯光纤，可以检测光纤弯曲方向。
其采用了多种技术，如单个的FBG、宏弯曲调制器、多芯光子晶体光纤模场变化和弯曲引起的芯串扰。
\\
\\
分布式弯曲传感 & \textasciitilde 1996 & 通过多路复用，光纤能够通过FBG在多个位置检测应变。 
最初，只有波分和时分多路复用用于光纤形状感测，这限制了传感器的数量和最小的弯曲半径。
\\
\\
第一款商用3D光纤形变传感（ShapeTape）& \textasciitilde 1999 & ShapeTape是最早用于计算物体形状和表面的光纤3D测量设备之一。 
它是在1990年代基于光纤压力传感器开发的。 
由于价格高，范围、灵活性和准确性都很有限，ShapeTape在商业上并不成功。
\\
\\
基础光纤形变传感 & \textasciitilde 2000 & 通过多路复用检测多个位置处的弯曲，为三维形状感测提供了机会。
三个或更多芯的光纤提供了在多个位置检测方向应变的能力，从而可以重构空间中的光缆形状。
\\
\\
分布式光纤形变传感 & \textasciitilde 2004 & 在多个磁芯上数千个应变位置的检测使连续光栅感测三维形状成为可能，
从而消除了先前形状感测技术的离散性质。 
光频域反射计（Optical Frequency Domain Reflectometry, OFDR）可以利用普通光纤和连续光栅光纤中的瑞利反向散射光进行形状感测。
\\
\\
用于工业和医疗机器人的光纤形变传感 & \textasciitilde 2006 & 各种专利的出现促使着工业和医疗器械中FOSS的使用，
这是工业界第一次在实际应用中对FOSS表现出兴趣。
\\
\\
螺旋光纤布拉格光栅传感器 & \textasciitilde 2008 & 这篇论文是对多芯光纤中使用螺旋FBG进行扭曲和弯曲测量的第一个演示，
这为如何基于FOSS实现完整的3D重建提供了改进思路。
\\
\\
光纤形变传感可视化 & \textasciitilde 2009 & 随着返回信号愈发复杂，渲染出使用光纤形状感测的电缆变得更具挑战性。
自2009年以来，越来越多的论文和专利概述了实时渲染FOSS输出的各种方法。
\\
\\
基于光纤形变传感器的力传感 & \textasciitilde 2013 & 使用光纤形状感测电缆测量力不仅可以检测光纤的位置，
还可以检测该点的力。这些论文和专利自2013年以来由医疗器械公司出版，
为多功能形状传感器开辟了道路。
\\
\\
基于多芯光纤和分布式FOSS的分布式布里渊散射 & \textasciitilde 2016 & 首次演示了通过多芯光纤（Multi-Core Fiber, MCF）
中偏心纤芯的布里渊频移来测量长光纤（1km）中的曲率，为远程形状感测带来了新的可能性。
\\
\\
螺旋多芯光纤中的连续光栅 & \textasciitilde 2017 & 关于连续光栅多芯光纤的研究有了新的进展。
复合多芯光纤的商业可用性对于开发高分辨率和分布式FOSS来说至关重要。
\\
\bottomrule
\end{tabular}
\end{center}
\caption{FOSS的发展趋势\cite{recent-dev-in-foss}}
\label{table:foss}
\end{table}
\FloatBarrier


\subsection{本文研究的内容}

构建运行在浏览器上的可视化软件需要考虑以下几个问题：

\begin{itemize}
\item 如何通过传感器获取的数据重建出曲线的空间各点坐标？
\item 如何根据各点坐标渲染出三维图形？
\item 又如何将服务端重建的点坐标安全又实时地传输到客户端渲染程序？
\end{itemize}

本文提出了一种结合Cartesian坐标系和Frenet标架上两种重建算法的改良算法，
兼具重建精度高和运行速度快的优点，并给出了它的伪代码实现。

另外，本文根据HTTPS和WebSocket实现了全套的前后端数据传输，
并基于OpenGL和Threejs构建了运行在浏览器上的通用渲染程序，
任何能够直接或间接测量两个正交方向的曲率的传感器均可使用该程序实现曲线实时可视化。

本节主要介绍改良的重建算法和曲线重建可视化的实现步骤，具体的软件构建方案将在后面两章中介绍。

\subsubsection{改良重建算法}

在介绍改良算法之前，本文先简要介绍Cartesian坐标系二维情况下的曲线重建算法。

\begin{itemize}

\item \textbf{二维曲线} \\

\FloatBarrier
\begin{figure}
\centering
\includegraphics{2d-reconst.pdf}
\caption{基于Cartesian坐标系的二维曲线重建原理}
\label{fig:2d-reconst} 
\end{figure}
\FloatBarrier

如图~\ref{fig:2d-reconst}所示，以曲线的每个$ds$微段的端点$o_i$为原点建立运动坐标系 $o_i-a_ib_i$，
其中$\vec b_i$是曲线在$o_i$点的切向量，$\vec a_i$是法向量。

已知微段曲率值为$k_i$，则有：
\begin{equation}
\theta_i = ds\cdot k_i
\end{equation}
根据几何关系易得：

运动坐标系$o_i-a_ib_i$到运动坐标系$o_{i+1}-a_{i+1}b_{i+1}$的旋转矩阵$r_{i, i+1}$满足：
    \begin{equation}
    r_{i, i+1} = \left[
      \begin{matrix}
      cos \theta_i & sin \theta_i\\
      -sin \theta_i & cos \theta_i\\
      \end{matrix}
    \right]
    \end{equation}
    
$o_{i+1}$在运动坐标系$o_i-a_ib_i$中的相对坐标$t_{i+1}$满足：
    \begin{equation}
    t_{i+1} = \frac{1}{k_i} \cdot \left[
      \begin{matrix}
    	1 - cos\theta_i\\
      sin\theta_i\\
      \end{matrix}
    \right]
    \end{equation}
    

故可得：

绝对坐标系$o_0-a_0b_0$到运动坐标系$o_i-a_ib_i$的旋转矩阵$R_i$满足：
    \begin{equation}
    R_i = \prod_{k = 0}^{i-1} r_{k, k+1}
    \end{equation}

$o_i$ 到$o_{i+1}$在绝对坐标系中的位移向量$\vec{t_{i+1}}$满足
    \begin{equation}
    \vec{t_{i+1}} = Ri^{-1}\cdot t_{i+1}
    \end{equation}
    
$o_i$在绝对坐标系中的坐标 $T_i$满足：
    \begin{equation}
    T_i = \left[
    		\begin{matrix}
        0\\
        0\\
      	\end{matrix}
      \right]
      + \Sigma_{k=1} ^ {i} \vec{t_i}
    \end{equation}
    
至此，我们通过二维曲线上各微段弧长和曲率拟合出了各端点的绝对坐标。

\item \textbf{三维曲线} \\

\FloatBarrier
\begin{figure}
\centering
\includegraphics[scale=0.3]{coordinate-reconst.png}
\caption{基于Cartesian坐标系的三维曲线重建原理}
\label{fig:coordinate-reconst} 
\end{figure}
\FloatBarrier

如图 ~\ref{fig:coordinate-reconst} 所示，在三维情况下，我们以曲线的每个$ds$微段的端点$o_i$为原点建立运动坐标系\cite{three-dimensional-curve} $o_i-a_ib_ic_i$，
其中$\vec{c_i}$是曲线在$o_i$点的切向量，$\vec{a_i}$是法向量，$\vec{b_i}$是副法向量。
\begin{equation}
\vec{b_i} = \vec{a_i} \times \vec{c_i}
\end{equation}

这一点区别于传统的基于Cartesian坐标系的三维曲线重建，我们的运动坐标系不再使用$o_i-x_iy_iz_i$。
这样每次迭代能省去一次矩阵运算，并且可以分别迭代分离旋转矩阵和平移拉伸矩阵。

假设微段合曲率向量为$\vec{k_i}$，则同样有：
\begin{equation}
\theta_i = ds\cdot |\vec{k_i}|
\end{equation}
要求运动坐标系$o_i-a_ib_ic_i$到运动坐标系$o_{i+1}-a_{i+1}b_{i+1}c_{i+1}$的旋转矩阵$r_{i, i+1}$，需先求$\vec{k_i}$与$\vec{a_i}$的夹角$\phi_i$。

已知两个曲率分量$kx$和$ky$，将各运动坐标轴的$o-ab$平面叠加可得到下图的$o-xy$平面，其中$x$和$y$分别是两个曲率方向。由于$\vec{a}$是曲线法向量，故$\vec{a_{i+1}}$与$\vec{k_i}$同向，即$\vec{a_{i+1}}$与$\vec{a_{i+2}}$的夹角$\phi_{i+1}$是合曲率向量$\vec{k_i}$与$\vec{k_{i+1}}$的夹角。

\FloatBarrier
\begin{figure}
\centering
\includegraphics{iterate-phi.pdf}
\caption{运动坐标系旋转俯视图}
\label{fig:iterate-phi} 
\end{figure}
\FloatBarrier

又由于$x$的方向恒定（不发生扭转的情况下），故有：

\begin{align}
\phi_{i+1} &= \alpha_{i+1} - \alpha_i \\
\alpha_i &= arccos\frac{|kx_i|}{|k_i|} \\
k_i &= kx_i + ky_i \\
|k_i| &= \sqrt{(kx_i)^2 + (ky_i)^2}
\end{align}

算得$\phi_i$后可易得：

运动坐标系$o_i-a_ib_ic_i$到临时坐标系$o_i'-a_i'b_i'c_i'$的旋转矩阵$r_i'$满足：
    \begin{equation}
    r_i' = \left[
            \begin{matrix}
            cos\phi_i & -sin\phi_i & 0\\
            sin\phi_i & cos\phi_i & 0\\
            0 & 0 & 1\\
            \end{matrix}
        \right]
    \end{equation}
    
点$o_{i+1}$在临时坐标系$o_i'-a_i'b_i'c_i'$下的相对坐标$o_{i+1}'$满足：
    \begin{equation}
    o_{i+1}' = \frac{1}{|k_i|} \cdot \left[
      \begin{matrix}
    	1 - cos\theta_i\\
    	0 \\
      sin\theta_i\\
      \end{matrix}
    \right]
    \end{equation}
    
临时坐标系$o_i'-a_i'b_i'c_i'$到运动坐标系$o_{i+1}-a_{i+1}b_{i+1}c_{i+1}$的旋转矩阵$r_{i, i+1}$满足：
    \begin{equation}
    r_{i, i+1} = \left[
      \begin{matrix}
      cos \theta_i & 0 & -sin \theta_i\\
      0 &1 & 0\\
      sin \theta_i & 0 & cos \theta_i\\
      \end{matrix}
    \right]
    \end{equation}

故可得：

绝对坐标系$o_0-a_0b_0c_0$到临时坐标系$o_i'-a_i'b_i'c_i'$的旋转矩阵$R_i'$满足：
    \begin{equation}
    R_i' = r_i' \cdot \prod_{k = 0}^{i-1} r_k' \cdot r_{k, k+1}
    \end{equation}
    
$o_i$ 到$o_{i+1}$在绝对坐标系中的位移向量$\vec{t_{i+1}}$满足：
    \begin{equation}
    \vec{t_i} = Ri'^{-1}\cdot o_{i+1}'
    \end{equation}

绝对坐标原点$o_0$ 到$o_i$的位移向量$\vec{T_i}$满足：
    \begin{equation}
    \vec{T_i} = \Sigma_{k=1} ^ {i} \vec{t_i}
    \end{equation}

即$o_i$在绝对坐标系中的坐标 $T_i$满足\cite{用于光纤光栅曲线重建算法的坐标点拟合}：
\begin{equation}
T_i = \left[
    \begin{matrix}
    0\\
    0\\
    0\\
  	\end{matrix}
  \right]
  + \Sigma_{k=1} ^ {i} \vec{t_i}
\end{equation}

\end{itemize}

\subsubsection{实现步骤}

可视化的实现可分为三步：数据连续化、曲线坐标重建和图形渲染。
本小节将大致介绍这三个步骤，其中采用的数据表达格式为JSON\cite{rfc7159}。

\begin{itemize}

\item \textbf{数据连续化} \\
连续化步骤直接接收原始数据。原始数据是整个流程的输入数据，其内容大致为：

\begin{lstlisting}[language=json,firstnumber=1,label={lst:raw-data},caption={原始曲率数据样例}]
{
    "ds": 0.01,
    "samples": [
        [0, 0, 0],
        [4.66, 0.21, -0.11],
        [9.36, 0.27, -0.13],
        [14.82, 0.086, -0.21],
        [19.72, -0.0093, 0.08],
        [24.74, -0.091, -0.07],
        [29.95, -0.079, 0],
        ...
    ]
}
\end{lstlisting}

其中 $d_s$ 为建议插值步长，
$samples$ 数组内的每个元素都是一个三元组，三个数据分别代表与原点的距离$s$、$a$方向的曲率$k_a$和$b$方向的曲率$k_b$。

连续化的输出内容大致为：

\begin{lstlisting}[language=json,firstnumber=1,label={lst:curvature-vec},caption={插值曲率数据样例}]
{
    "ds": 0.02,
    "ks": [
        [0, 0],
        [0.005, -0.004],
        [0.009, -0.007],
        [0.013, -0.008],
        [0.017, 0.0023],
        [0.022, 0.006],
        [0.025, 0.008],
        [0.031, 0.012],
        [0.033, 0.007],
        [0.03, 0.01],
        ...
    ]
}
\end{lstlisting}

其中 $d_s$ 为实际采用的插值步长，
$ks$ 数组内的每个元素都是一个二元组，两个数据分别代表$a$方向的曲率$k_a$和$b$方向的曲率$k_b$。

\item \textbf{曲线坐标重建} \\
曲线坐标重建的输入数据为连续化后的曲率数据。根据曲率数据重建后输出坐标数据：

\begin{lstlisting}[language=json,firstnumber=1,label={lst:positions},caption={重建坐标点数据样例}]
{
    "timestamp": 1595915002,
    "points": [
        [0.009999833069741726,1.0000499486923218,0],
        [0.019999666139483452,0.9999996423721313,0],
        [0.029998499900102615,0.9998496174812317,0],
        [0.03999536111950874,0.9996007680892944,0],
        [0.04998929798603058,0.9992536902427673,0],
        [0.059979379177093506,0.998809278011322,0],
        [0.0699646919965744,0.998268187046051,0],
        [0.07994434982538223,0.9976312518119812,0],
        [0.08991748839616776,0.9968992471694946,0],
        [0.09988325089216232,0.9960729479789734,0],
        [0.10984081774950027,0.9951531291007996,0],
        [0.11978939175605774,0.994140625,0],
        [0.009999833069741726,1.0000499486923218,0],
        ...
    ]
}
\end{lstlisting}

其中$timestamp$是数据产生时的时间戳，$points$数组内的每个元素都是一个三元组，
三个数分别是$x$轴、$y$轴和$z$轴的坐标。

\item \textbf{图形渲染} \\

首先根据下推的点列拟合一条Catmull Rom曲线，再根据需求渲染轴线或管壁。

渲染轴线可直接选择线性基础材质并进行曲线渲染；
渲染管壁则需要选择直径等几何属性以及反光度等材质属性才能进行渲染。
渲染完成则得到一帧图像。

实时地输入曲率数据则可得到实时的轴线或管壁图像。

\end{itemize}

